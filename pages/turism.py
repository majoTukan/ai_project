# Importamos las bibliotecas necesarias
import streamlit as st
from utils.questions import *
from utils.questions_ai import *

# Configura la p√°gina
st.set_page_config(page_title="Trivia de Turismo", layout="centered")

# Verifica que se hayan cargado las preguntas correctamente desde app.py
if "preguntas" not in st.session_state or "pregunta_actual" not in st.session_state:
    st.error("‚ö†Ô∏è Primero inicia la trivia desde el men√∫ de inicio.")
    st.stop()

# Inicializamos resultados si no existen a√∫n
if "resultados" not in st.session_state:
    st.session_state.resultados = []

# Cargamos preguntas e √≠ndice actual
preguntas = st.session_state.preguntas
idx = st.session_state.pregunta_actual
actual = preguntas[idx]

# Asegura que tenga tipo definido (por compatibilidad con preguntas viejas)
tipo = actual.get("tipo", "opcion_multiple")

# T√≠tulo de pregunta
st.subheader(f"Pregunta {idx + 1} de {len(preguntas)}")
st.markdown(f"**{actual['pregunta']}**")


# Mostrar opciones seg√∫n el tipo
if tipo == "opcion_multiple":
    opciones = actual["opciones"]
elif tipo == "verdadero_falso":
    opciones = ["Verdadero", "Falso"]
else:
    st.error("Tipo de pregunta no soportado.")
    st.stop()

respuesta = st.radio("Selecciona tu respuesta:", opciones, key=f"radio_{idx}")
# Verificaci√≥n controlada por estado
if f"verificada_{idx}" not in st.session_state:
    st.session_state[f"verificada_{idx}"] = False

# Bot√≥n verificar respuesta
if st.button("Verificar", key=f"verificar_{idx}") and not st.session_state[f"verificada_{idx}"]:
    correcta = actual.get("correcta") or actual.get("respuesta_correcta")
    correcto = respuesta == correcta

    st.session_state.resultados.append({
        "pregunta": actual["pregunta"],
        "respuesta": respuesta,
        "correcta": correcta,
        "es_correcta": correcto,
        "explicacion": actual["explicacion"]
    })

    st.session_state[f"verificada_{idx}"] = True

    if correcto:
        st.success("‚úÖ ¬°Correcto!")
    else:
        st.error(f"‚ùå Incorrecto. La respuesta correcta es: {correcta}")

    st.markdown(f"üìò **Explicaci√≥n:** {actual['explicacion']}")

# Mostrar bot√≥n para avanzar si ya se verific√≥
if st.session_state[f"verificada_{idx}"]:
    if idx < len(preguntas) - 1:
        if st.button("Siguiente pregunta", key=f"siguiente_{idx}"):
            st.session_state.pregunta_actual += 1
            st.rerun()
    else:
        st.success("üéâ ¬°Has completado la trivia!")
        if st.button("Volver al men√∫ principal"):
            st.switch_page("app.py")
